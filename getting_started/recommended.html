<!DOCTYPE html><head><meta charset="UTF-8"><title>Recommended Executioner and Preconditioning Settings | Moltres</title><link href="../contrib/materialize/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"></link><link href="../contrib/prism/prism.min.css" type="text/css" rel="stylesheet"></link><link href="../css/moose.css" type="text/css" rel="stylesheet"></link><link href="../css/devel_moose.css" type="text/css" rel="stylesheet"></link><link href="../css/alert_moose.css" type="text/css" rel="stylesheet"></link><link href="../css/content_moose.css" type="text/css" rel="stylesheet"></link><link href="../css/sqa_moose.css" type="text/css" rel="stylesheet"></link><link href="../css/civet_moose.css" type="text/css" rel="stylesheet"></link><link href="../css/moltres.css" type="text/css" rel="stylesheet"></link><script type="text/javascript" src="../contrib/jquery/jquery.min.js"></script></head><body><div class="page-wrap"><header><nav><div class="nav-wrapper container"><a href="../index.html" class="left moose-logo hide-on-med-and-down" id="home-button">Moltres</a><a href="https://github.com/arfc/moltres" class="right"><img src="../media/framework/github-logo.png" alt="GitHub wordmark" class="github-mark"></img><img src="../media/framework/github-mark.png" alt="GitHub logo" class="github-logo"></img></a><ul class="right hide-on-med-and-down"><li><a href="#!" class="dropdown-trigger" data-target="6a88867e-ef32-4aa5-b47e-5f3350bd9cb2" data-constrainWidth="false">Getting Started<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="#!" class="dropdown-trigger" data-target="f3e7b8e2-ba15-4518-a16d-fada5062d538" data-constrainWidth="false">Documentation<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="#!" class="dropdown-trigger" data-target="8698f1bd-0744-4bc2-b8cb-40ebd03024ef" data-constrainWidth="false">Help<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="../citing.html">Citing</a></li></ul><a href="#" class="sidenav-trigger" data-target="cf0dc138-d8a7-4cbf-8bd3-4e31ed1bd9d6"><i class="material-icons">menu</i></a><ul class="sidenav" id="cf0dc138-d8a7-4cbf-8bd3-4e31ed1bd9d6"><li><a href="#!" class="dropdown-trigger" data-target="0a7f1169-08df-40d3-9e80-d8bb235b5372" data-constrainWidth="false">Getting Started<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="#!" class="dropdown-trigger" data-target="089b390b-0f76-434d-80cd-c6ad98aad895" data-constrainWidth="false">Documentation<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="#!" class="dropdown-trigger" data-target="3f923336-f916-46d4-8998-a8d13aafc0fd" data-constrainWidth="false">Help<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="../citing.html">Citing</a></li></ul><a href="#moose-search" class="modal-trigger"><i class="material-icons">search</i></a></div><ul class="dropdown-content" id="6a88867e-ef32-4aa5-b47e-5f3350bd9cb2"><li><a href="installation.html">Install Moltres</a></li><li><a href="theory.html">Theory</a></li><li><a href="tutorials.html">Tutorials</a></li></ul><ul class="dropdown-content" id="f3e7b8e2-ba15-4518-a16d-fada5062d538"><li><a href="../syntax/index.html">Moltres Syntax</a></li><li><a href="https://mooseframework.inl.gov/source/index.html">MOOSE Syntax</a></li><li><a href="../doxygen/classes.html">Moltres Doxygen</a></li><li><a href="https://mooseframework.inl.gov/docs/doxygen/moose/classes.html">MOOSE Doxygen</a></li><li><a href="../development/contributing.html">Contributing</a></li><li><a href="../publications.html">List of Publications</a></li></ul><ul class="dropdown-content" id="8698f1bd-0744-4bc2-b8cb-40ebd03024ef"><li><a href="https://github.com/arfc/moltres/discussions">Moltres Discussion Forum</a></li><li><a href="https://github.com/idaholab/moose/discussions">MOOSE Discussion Forum</a></li></ul><ul class="dropdown-content" id="0a7f1169-08df-40d3-9e80-d8bb235b5372"><li><a href="installation.html">Install Moltres</a></li><li><a href="theory.html">Theory</a></li><li><a href="tutorials.html">Tutorials</a></li></ul><ul class="dropdown-content" id="089b390b-0f76-434d-80cd-c6ad98aad895"><li><a href="../syntax/index.html">Moltres Syntax</a></li><li><a href="https://mooseframework.inl.gov/source/index.html">MOOSE Syntax</a></li><li><a href="../doxygen/classes.html">Moltres Doxygen</a></li><li><a href="https://mooseframework.inl.gov/docs/doxygen/moose/classes.html">MOOSE Doxygen</a></li><li><a href="../development/contributing.html">Contributing</a></li><li><a href="../publications.html">List of Publications</a></li></ul><ul class="dropdown-content" id="3f923336-f916-46d4-8998-a8d13aafc0fd"><li><a href="https://github.com/arfc/moltres/discussions">Moltres Discussion Forum</a></li><li><a href="https://github.com/idaholab/moose/discussions">MOOSE Discussion Forum</a></li></ul></nav><div class="modal modal-fixed-footer moose-search-modal" id="moose-search"><div class="modal-content container moose-search-modal-content"><div class="row"><div class="col l12"><div class="input-field"><input type_="text" onkeyup="mooseSearch()" placeholder="/index.md" id="moose-search-box"></input></div></div><div><div class="col s12" id="moose-search-results"></div></div></div></div><div class="modal-footer"><a href="#!" class="modal-close btn-flat">Close</a></div></div></header><main class="main"><div class="container"><div class="row"><div class="col hide-on-med-and-down l12"><nav class="breadcrumb-nav"><div class="nav-wrapper"><span class="breadcrumb">getting_started</span><a href="#" class="breadcrumb">recommended</a></div></nav></div></div><div class="row"><div class="moose-content col s12 m12 l10"><section id="5fe7faab-d02b-4c17-98e2-79a732b004b7" data-section-level="1" data-section-text="Recommended Executioner and Preconditioning Settings"><h1 id="recommended-executioner-and-preconditioning-settings">Recommended Executioner and Preconditioning Settings</h1><p>This page provides recommended <code>Executioner</code> and <code>Preconditioning</code> settings for new Moltres users who already have basic proficiency with MOOSE. The following sections provide recommendations on the solve type, automatic scaling, time integration scheme, and preconditioning settings.</p><p>Moltres, like all MOOSE-based apps, rely on PETSc for preconditioning. Refer to MOOSE&#x27;s documentation <a href="https://mooseframework.inl.gov/syntax/Preconditioning/index.html">here</a> for basic information on preconditioning in MOOSE. You may also refer to the example input file <a href="http://arfc.github.io/software/moltres/wiki/input_example/">here</a> for an introduction to the Moltres input file format.</p><section class="scrollspy" id="fbafd4c6-d2d5-4978-bdc0-5873c03edfee" data-section-level="2" data-section-text="Solve Type"><h2 id="solve-type">Solve Type</h2><p>Previous experiences have shown that Moltres simulations usually require the <code>NEWTON</code> solve type with all off-diagonal Jacobian entries enabled because reactor neutronics problems are very non-linear from the strong coupling between the neutron group flux and delayed neutron precursor concentration variables. Users may use these settings by setting <code>solve_type = NEWTON</code> and <code>full = true</code> in the <code>Executioner</code> and <code>Preconditioning</code> blocks, respectively, in the input file.</p></section><section class="scrollspy" id="af9ad942-2a23-490c-bb0b-18d5b9831444" data-section-level="2" data-section-text="Automatic Scaling"><h2 id="automatic-scaling">Automatic Scaling</h2><p>Relevant variables in a Moltres simulation include neutron group fluxes, delayed neutron precursor concentrations, temperature, and velocity components. These variables differ significantly in magnitude, especially between the neutronics and thermal-hydraulics variables. We recommend applying scaling factors to the variables so that: 1) final residual norm values are on similar orders of magnitudes to ensure that every variable is converged at the end of each step, and 2) the Jacobian is well-conditioned.</p><p>Users may manually set the scaling factor for each variable using the <code>scaling</code> parameter when defining the variable. Alternatively, we recommend using the <code>automatic_scaling</code> feature from MOOSE. This feature automatically calculates the appropriate scaling factor for each variable.</p><p>We recommend using the following parameters to set automatic scaling in the <code>Executioner</code> block.</p><pre style="max-height:350px;"><code class="language-text">
automatic_scaling = true
resid_vs_jac_scaling_param = 0.2
scaling_group_variables = &#x27;group1 group2; pre1 pre2 pre3 pre4 pre5 pre6 pre7 pre8; temp&#x27;
compute_scaling_once = false
off_diagonals_in_auto_scaling = true
</code></pre><ul class="browser-default"><li><p><code>automatic_scaling</code>: Turns on automatic scaling. </p></li><li><p><code>resid_vs_jac_scaling_param</code>: Determines whether the scaling factor is based on the residual or Jacobian entries; <code>0</code> corresponds to pure Jacobian scaling and <code>1</code> corresponds to pure residual scaling while all values in between correspond to hybrid scaling. The ideal value for this parameter depends heavily on the type of simulation. Most Moltres simulations run faster with this parameter at 0.1~0.3. </p></li><li><p><code>scaling_group_variables</code>: Groups variables which share the same scaling factor. The MOOSE team recommends grouping variables derived from the same physics for stability. </p></li><li><p><code>compute_scaling_once</code>: Whether Moltres calculates the scaling factors once at the beginning of the simulation (<code>true</code>) or at the beginning of every timestep (<code>false</code>). </p></li><li><p><code>off_diagonals_in_auto_scaling</code>: Whether to consider off-diagonals when determining automatic scaling factors.</p></li></ul></section><section class="scrollspy" id="dd7f8a06-2813-4f5b-bdc9-e305717cd26c" data-section-level="2" data-section-text="Time Integration Scheme"><h2 id="time-integration-scheme">Time Integration Scheme</h2><p>We recommend using either <code>ImplicitEuler</code> or <code>BDF2</code> based on the first and second order backward differentiation formula time integration schemes. The <code>BDF2</code> scheme is more accurate (higher-order) and has a <a href="https://mooseframework.inl.gov/workshop/#/33/4">superior convergence rate</a>.</p><p>All multi-stage time integration schemes from MOOSE are incompatible with Moltres simulations.</p><p>To set the time integration scheme, include the following line in the <code>Executioner</code> block.</p><pre style="max-height:350px;"><code class="language-text">
scheme = bdf2    # or implicit-euler for ImplicitEuler
</code></pre></section><section class="scrollspy" id="6d105f4d-5982-4b06-ae4c-37176635a79e" data-section-level="2" data-section-text="Preconditioning"><h2 id="preconditioning">Preconditioning</h2><p>Our discussions on preconditioning here relate to the <code>NEWTON</code> solve type which relies on PETSc routines to solve the system of linear equations in each Newton iteration.</p><p>Users can pick their preferred linear system solver and the associated settings in PETSc for their problem through the <code>petsc_options_iname</code> and <code>petsc_options_value</code> parameters in the <code>Executioner</code> block.</p><section id="62865b28-f1c2-44f9-8bdb-6705bb450bb7" data-section-level="4" data-section-text="LU"><h4 id="lu">LU</h4><p>The most reliable &quot;preconditioner&quot; type for Moltres simulations is <code>lu</code>. <code>lu</code> is actually a direct solver based on LU factorization. As a direct solver, it is very accurate as long as the user provides the correct Jacobian formulations in their kernels. PETSc&#x27;s default <code>lu</code> implementation is serial and thus, it does not scale over multiple processors. <code>lu</code> requires the <code>superlu_dist</code> parallel library to be effective over multiple processors. However, <code>superlu_dist</code> does not scale as well as the <code>asm</code> option in the next section. As such, we recommend only using <code>superlu_dist</code> for smaller problems (&lt;100k DOFs).</p><p><code>lu</code> on a single process:</p><pre style="max-height:350px;"><code class="language-text">
petsc_options_iname = &#x27;-pc_type -pc_factor_shift_type&#x27;
petsc_options_value = &#x27;lu       NONZERO&#x27;
</code></pre><p><code>lu</code> with <code>superlu_dist</code> on multiple MPI processes:</p><pre style="max-height:350px;"><code class="language-text">
petsc_options_iname = &#x27;-pc_type -pc_factor_shift_type -pc_factor_mat_solver_type&#x27;
petsc_options_value = &#x27;lu       NONZERO               superlu_dist&#x27;
</code></pre></section><section id="8e5d4cc4-1b2d-422f-b344-9457a3769837" data-section-level="4" data-section-text="ASM"><h4 id="asm">ASM</h4><p>Direct solvers like <code>lu</code> do not scale well with problem size. Iterative methods are recommended for large problems. The best performing preconditioner type for large problems in Moltres is <code>asm</code>. <code>asm</code> is based on the Additive Schwarz Method (ASM) for generating preconditioners for the GMRES iterative method. Moltres simulations also require a strong subsolver like <code>lu</code> for solving each subdomain.</p><p><code>asm</code> on multiple MPI processes:</p><pre style="max-height:350px;"><code class="language-text">
petsc_options_iname = &#x27;-pc_type -sub_pc_type -sub_pc_factor_shift_type -pc_asm_overlap -ksp_gmres_restart&#x27;
petsc_options_value = &#x27;asm      lu           NONZERO                   1               200&#x27;
</code></pre></section><section id="f933b066-8d72-441f-82cd-3333681dd881" data-section-level="4" data-section-text="Preconditioner Recommendations"><h4 id="preconditioner-recommendations">Preconditioner Recommendations</h4><p>Here are the recommended preconditioner settings for the following problem sizes:</p><p>Small problems (&lt;10k DOFs)</p><ul class="browser-default"><li><p>Number of MPI processes: 1-4 </p></li><li><p>Preconditioner options: - <code>lu</code> on 1 process - <code>lu</code> with <code>superlu_dist</code> on multiple processes - <code>asm</code> on multiple processes</p></li></ul><p>Medium problems (&lt;100k DOFs)</p><ul class="browser-default"><li><p>Number of MPI processes: 4-16 </p></li><li><p>Preconditioner options: - <code>lu</code> with <code>superlu_dist</code> on multiple processes - <code>asm</code> on multiple processes</p></li></ul><p>Large problems (&gt;100k DOFs)</p><ul class="browser-default"><li><p>Number of MPI processes: Up to 1 MPI process per 10k DOFs </p></li><li><p>Preconditioner options: - <code>asm</code> on multiple processes</p></li></ul></section></section><section class="scrollspy" id="027fe3d3-a8c1-48fa-85f1-81d21cc7d7b5" data-section-level="2" data-section-text="General tips"><h2 id="general-tips">General tips</h2><ul class="browser-default"><li><p><code>lu</code> is faster than <code>asm</code> for small problems. </p></li><li><p><code>l_tol = 1e-5</code> is the default linear tolerance value. <code>l_tol</code> can be raised to 1e-4 or 1e-3 for large problems without much impact on performance if the problem requires too many linear iterations (&gt;400) on every nonlinear iteration. </p></li><li><p>Automatic scaling may not scale correctly on the first timestep when restarting a Moltres simulation using MOOSE&#x27;s <code>Restart</code> functionality. Thus, the simulation may fail to converge on the first timestep. </p></li><li><p>When using <code>asm</code>, the number of linear iterations required per nonlinear iteration scales linearly with the number of subdomains (i.e. number of MPI processes). As such, increasing the number of processors beyond a certain threshold increases the solve time.</p></li></ul></section></section></div><div class="col hide-on-med-and-down l2"><div class="toc-wrapper pin-top"><ul class="section table-of-contents"><li><a href="#fbafd4c6-d2d5-4978-bdc0-5873c03edfee" class="tooltipped" data-position="left" data-tooltip="Solve Type">Solve Type</a></li><li><a href="#af9ad942-2a23-490c-bb0b-18d5b9831444" class="tooltipped" data-position="left" data-tooltip="Automatic Scaling">Automatic Scaling</a></li><li><a href="#dd7f8a06-2813-4f5b-bdc9-e305717cd26c" class="tooltipped" data-position="left" data-tooltip="Time Integration Scheme">Time Integration Scheme</a></li><li><a href="#6d105f4d-5982-4b06-ae4c-37176635a79e" class="tooltipped" data-position="left" data-tooltip="Preconditioning">Preconditioning</a></li><li><a href="#027fe3d3-a8c1-48fa-85f1-81d21cc7d7b5" class="tooltipped" data-position="left" data-tooltip="General tips">General tips</a></li></ul></div></div></div></div></main></div></body><script type="text/javascript" src="../contrib/materialize/materialize.min.js"></script><script type="text/javascript" src="../contrib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="../contrib/prism/prism.min.js"></script><script type="text/javascript" src="../js/init.js"></script><script type="text/javascript" src="../js/navigation.js"></script><script type="text/javascript" src="../contrib/fuse/fuse.min.js"></script><script type="text/javascript" src="../js/search_index.js"></script><script type="text/javascript" src="../js/sqa_moose.js"></script>